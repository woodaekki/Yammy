stages:
  - Test_Build
  - FE_Image
  - BE_Image
  - Deploy

variables:
  ECR_REPOSITORY_URI: 725115073641.dkr.ecr.ap-northeast-2.amazonaws.com/yammy
  APP_DIR: .
  FRONTEND_DIR: Yammy-FE
  BACKEND_DIR: Yammy-BE/yammy

# =========================================================
# ğŸ¯ Test_Build_BE: í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„± ë° ë¹Œë“œ (í™•ì¸ ëŒ€ìƒ)
# =========================================================
Test_Build_BE:
  stage: Test_Build
  image: openjdk:17-jdk-slim
  tags:
    - test-build # docker executoreë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒˆë¡œ ìƒì„±ëœ ëŸ¬ë„ˆ
  services:
    - name: mysql:8.0
      alias: mysql-db
    - name: redis:latest
      alias: redis

  variables:
    # 1. MySQL ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ ìì²´ ì„¤ì • ë³€ìˆ˜
    MYSQL_DATABASE: testdb
    MYSQL_ROOT_PASSWORD: root_password

    # 2. Spring Bootê°€ ì°¸ì¡°í•  í™˜ê²½ ë³€ìˆ˜ (GitLab CIì—ì„œ ì¡°í•©)
    DB_URL: jdbc:mysql://mysql-db:3306/${MYSQL_DATABASE}?serverTimezone=Asia/Seoul
    DB_USERNAME: root
    DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}

    SPRING_DATA_REDIS_HOST: redis
    SPRING_DATA_REDIS_PORT: 6379
    SPRING_DATA_REDIS_PASSWORD:

    # ì¶”ê°€ ë³€ìˆ˜ë“¤ì€ GitLab CI/CD Variablesì— ë“±ë¡ë˜ì–´ ì‚¬ìš©ëœë‹¤ê³  ê°€ì •

  before_script:
    - cd ${BACKEND_DIR}
    - chmod +x gradlew

    - apt-get update -qq && apt-get install -y --no-install-recommends wait-for-it
    - wait-for-it mysql-db:3306 -t 30 -- echo "MySQL is up and running!"
    - wait-for-it redis:6379 -t 30 -- echo "Redis is up and running!"

    - | 
      MYSQL_HOST_IP=$(getent hosts mysql-db | awk '{ print $1 }');
      if [ -z "$MYSQL_HOST_IP" ]; then 
        MYSQL_HOST_IP="mysql-db"; # IPë¥¼ ì°¾ì§€ ëª»í•˜ë©´ alias ì‚¬ìš© (wait-for-itì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì‹œë„)
      fi;
      export DB_URL=jdbc:mysql://${MYSQL_HOST_IP}:3306/${MYSQL_DATABASE}?serverTimezone=Asia/Seoul

    - export DB_URL=$DB_URL
    - export DB_USERNAME=$DB_USERNAME
    - export DB_PASSWORD=$DB_PASSWORD
    - rm -f src/main/resources/application.yml
    - echo "$CI_APPLICATION_YML" > src/main/resources/application.yml
    - echo "application.yml created successfully with CI variables."

  script:
    - ./gradlew clean build

  artifacts:
    when: on_success
    paths:
      - ${BACKEND_DIR}/build/libs/*.jar
    expire_in: 1 week

FE_Image:
  stage: FE_Image
  image: docker:24.0.5
  tags:
    - test-build
  services:
    - name: docker:24.0.5-dind

  variables:
    FE_IMAGE_TAG: frontend-latest
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""

  script:
    - cd ${FRONTEND_DIR}

    - apk add --no-cache python3 py3-pip
    - pip install awscli
    - export AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY
    - export AWS_DEFAULT_REGION
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI

    - docker build -t $ECR_REPOSITORY_URI:$FE_IMAGE_TAG .
    - docker push $ECR_REPOSITORY_URI:$FE_IMAGE_TAG

BE_Image:
  stage: BE_Image
  image: docker:24.0.5
  tags:
    - test-build
  services:
    - name: docker:24.0.5-dind

  dependencies:
    - Test_Build_BE

  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    BE_IMAGE_TAG: backend-latest
    PROD_APPLICATION_YML: $PROD_APPLICATION_YML # GitLab CI/CD Variablesì— ë“±ë¡ëœ ìš´ì˜ YML ë‚´ìš©

  script:
    - cd ${BACKEND_DIR}

    - rm -f src/main/resources/application.yml
    - echo "$PROD_APPLICATION_YML" > src/main/resources/application-prod.yml

    - apk add --no-cache python3 py3-pip
    - pip install awscli
    - export AWS_ACCESS_KEY_ID
    - export AWS_SECRET_ACCESS_KEY
    - export AWS_DEFAULT_REGION
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI

    - docker build -t $ECR_REPOSITORY_URI:$BE_IMAGE_TAG .
    - docker push $ECR_REPOSITORY_URI:$BE_IMAGE_TAG

# --- Deploy Stage ---
Deploy:
  stage: Deploy
  # â­ï¸ tags: yammy_proejct_deplyer ëŸ¬ë„ˆì— í• ë‹¹ë˜ë„ë¡ íƒœê·¸ ì‚¬ìš© (í˜„ì¬ yammy-build íƒœê·¸ë¡œ ê°€ì •) â­ï¸
  tags:
    - yammy-build
  dependencies: [] # <-- ì´ ì¤„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
  # â­ï¸ image: Host OSì˜ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ â­ï¸
  image: ubuntu:latest # Shell Runnerê°€ imageë¥¼ ë¬´ì‹œí•˜ì§€ë§Œ, Alpine ë„êµ¬ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.

  # â­ï¸ variables: SSH ê´€ë ¨ ë³€ìˆ˜ ì œê±° (DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY) â­ï¸
  variables:
    # DB ì •ë³´ (docker-compose.ymlì— ì£¼ì…í•  ê°’)
    DB_URL: $PROD_DB_URL
    DB_USERNAME: $PROD_DB_USERNAME
    DB_PASSWORD: $PROD_DB_PASSWORD
    DB_NAME: $PROD_DB_USERNAME

    # ì´ë¯¸ì§€ ì •ë³´
    ECR_REPOSITORY_URI: $ECR_REPOSITORY_URI
    BE_IMAGE_URI: $ECR_REPOSITORY_URI:backend-latest
    FE_IMAGE_URI: $ECR_REPOSITORY_URI:frontend-latest
    AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION

  before_script:
    - echo "Starting deployment directly on EC2 host..."

    # â­ï¸ 1. AWS CLI ë° Docker Compose ì„¤ì¹˜ (sudo í•„ìš”) â­ï¸
    - sudo apt-get update -qq
    - sudo apt-get install -y awscli docker-compose

    # 2. ECR ë¡œê·¸ì¸ (Host OSì—ì„œ ì‹¤í–‰)
    # âš ï¸ Shell RunnerëŠ” root ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ sudo ì‚¬ìš©
    - sudo aws ecr get-login-password --region $AWS_DEFAULT_REGION | sudo docker login --username AWS --password-stdin $ECR_REPOSITORY_URI

    # 3. â­ï¸ Shell í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (docker-compose.ymlì´ ì°¸ì¡°) â­ï¸
    - export DB_URL=$DB_URL
    - export DB_USERNAME=$DB_USERNAME
    - export DB_PASSWORD=$DB_PASSWORD
    - export ECR_REPOSITORY_URI=$ECR_REPOSITORY_URI
    - export BE_IMAGE_URI=$BE_IMAGE_URI
    - export FE_IMAGE_URI=$FE_IMAGE_URI

  script:
    # 4. ìµœì‹  ì´ë¯¸ì§€ Pull ë° Docker Compose ì‹¤í–‰
    - sudo docker pull $BE_IMAGE_URI
    - sudo docker pull $FE_IMAGE_URI

    # 5. Docker Compose ì‹¤í–‰: ìµœì‹  ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
    # EC2ì˜ /home/ubuntu/docker-compose.yml íŒŒì¼ì„ ì‚¬ìš©
    - sudo docker-compose -f /home/ubuntu/docker-compose.yml up -d --force-recreate
