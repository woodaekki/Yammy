stages:
  - Test_Build
  - FE_Image
  - BE_Image
  - Deploy

variables:
  ECR_REPOSITORY_URI: 725115073641.dkr.ecr.ap-northeast-2.amazonaws.com/yammy
  APP_DIR: .
  FRONTEND_DIR: Yammy-FE
  BACKEND_DIR: Yammy-BE/yammy

# =========================================================
# ğŸ¯ Test_Build_BE: í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„± ë° ë¹Œë“œ (í™•ì¸ ëŒ€ìƒ)
# =========================================================
Test_Build_BE:
  stage: Test_Build
  image: openjdk:17-jdk-slim
  tags:
    - test-build # docker executoreë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒˆë¡œ ìƒì„±ëœ ëŸ¬ë„ˆ
  services:
    - name: mysql:8.0
      alias: mysql-db
    - name: redis:latest
      alias: redis

  variables:
    # 1. MySQL ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ ìì²´ ì„¤ì • ë³€ìˆ˜
    MYSQL_DATABASE: testdb
    MYSQL_ROOT_PASSWORD: root_password

    # 2. Spring Bootê°€ ì°¸ì¡°í•  í™˜ê²½ ë³€ìˆ˜ (GitLab CIì—ì„œ ì¡°í•©)
    DB_URL: jdbc:mysql://mysql-db:3306/${MYSQL_DATABASE}?serverTimezone=Asia/Seoul
    DB_USERNAME: root
    DB_PASSWORD: ${MYSQL_ROOT_PASSWORD}

    SPRING_DATA_REDIS_HOST: redis
    SPRING_DATA_REDIS_PORT: 6379
    SPRING_DATA_REDIS_PASSWORD:

    # ì¶”ê°€ ë³€ìˆ˜ë“¤ì€ GitLab CI/CD Variablesì— ë“±ë¡ë˜ì–´ ì‚¬ìš©ëœë‹¤ê³  ê°€ì •

  before_script:
    - cd ${BACKEND_DIR}
    - chmod +x gradlew

    # â­ï¸ ì¶”ê°€ë¨: ê¸°ì¡´ application.yml íŒŒì¼ ì‚­ì œ â­ï¸
    - echo "Deleting existing application.yml and creating CI version..."
    - rm -f src/main/resources/application.yml

    # í•µì‹¬: CIìš© YML ë‚´ìš©ì„ ë””ìŠ¤í¬ì— application.ymlë¡œ ìƒì„±
    - echo "$CI_APPLICATION_YML" > src/main/resources/application.yml
    - echo "application.yml created successfully with CI variables."

  script:
    - ./gradlew clean build

  artifacts:
    when: on_success
    paths:
      - ${BACKEND_DIR}/build/libs/*.jar
    expire_in: 1 week

# =========================================================
# âŒ ë‚˜ë¨¸ì§€ ìŠ¤í…Œì´ì§€: ì‹¤í–‰ ë°©ì§€ (í…ŒìŠ¤íŠ¸ í™•ì¸ìš©)
# =========================================================

FE_Image:
  stage: FE_Image
  # â­ï¸ imageë¥¼ dockerë¡œ ë³€ê²½í•˜ì—¬ build/push ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. â­ï¸
  image: docker:24.0.5
  tags:
    - test-build
  services:
    - name: docker:24.0.5-dind
      alias: docker
      # â­ï¸ DIND ì„œë¹„ìŠ¤ì— privileged ëª¨ë“œë¥¼ í™œì„±í™” â­ï¸
      entrypoint: ["/usr/local/bin/dockerd-entrypoint.sh", "--tls=false"] # TLS ë¹„í™œì„±í™” ì¶”ê°€
      command: ["--storage-driver=vfs"] # ì´ ì˜µì…˜ì€ ë¶ˆì•ˆì •í•  ë•Œ ì‹œë„

  variables:
    # ... (ECR ê´€ë ¨ ë³€ìˆ˜) ...
    FE_IMAGE_URI: $ECR_REPOSITORY_URI/yammy-fe:latest # ì´ë¯¸ì§€ ì´ë¦„ ëª…í™•í•˜ê²Œ ë¶„ë¦¬
    AWS_DEFAULT_REGION: ap-northeast-2
    # â­ï¸ ì¶”ê°€ë¨: DIND ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ì„¤ì • â­ï¸
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: "" # TLS ì¸ì¦ ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ (ì„ íƒì ì´ì§€ë§Œ ê¶Œì¥ë¨)

  script:
    - cd ${FRONTEND_DIR}

    # 1. ë¹Œë“œì™€ í‘¸ì‹œë¥¼ í•˜ë‚˜ì˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‹¤í–‰
    # Docker ë¹Œë“œì— í•„ìš”í•œ Node í™˜ê²½ì„ Dockerfile ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•©ë‹ˆë‹¤.
    # ECR ë¡œê·¸ì¸ ë° AWS CLI ì„¤ì¹˜ëŠ” docker:24.0.5 ì´ë¯¸ì§€ì—ì„œ ì§„í–‰
    - apk add --no-cache python3 py3-pip
    - pip install awscli
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPOSITORY_URI

    # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    # FE_Image ì¡ì€ ì´ì œ Node í™˜ê²½ì„ Dockerfile ë‚´ì˜ ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    - docker build -t $FE_IMAGE_URI .
    - docker push $FE_IMAGE_URI

BE_Image:
  stage: BE_Image
  script:
    - echo "Skipping BE Image build for Test."
  when: manual
  allow_failure: true

Deploy:
  stage: Deploy
  script:
    - echo "Skipping Deploy for Test."
  when: manual
  allow_failure: true